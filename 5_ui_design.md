# UI/デザイン

## 1. 検索 UI のレイアウト（再確認）

ヘッダ部分にこういう構成を想定します：

```html
<header class="hv-header">
  <input
    id="hv-search-input"
    type="search"
    placeholder="ヘルプを検索…"
    autocomplete="off"
  />
  <div
    id="hv-search-results"
    class="hv-search-results"
    aria-expanded="false"
    role="listbox"
  ></div>
</header>
```

`#hv-search-results` は「ドロップダウンパネル」風に表示：

* 初期状態：非表示（`display: none` or `visibility: hidden`）
* 検索文字列が入って結果があるときだけ表示
* 結果が0件でも「0件」のメッセージを表示するか、非表示にするかは仕様で決める（後述）

---

## 2. UI状態の定義

検索UIの状態を、内部的にこんな感じで持つ想定にします：

1. **Idle（待機）**

   * `input` は空、またはフォーカスされていない
   * 結果パネルは非表示
2. **Typing（入力中）**

   * `input` に1文字以上入っている
   * デバウンス中（検索実行前）
   * 結果パネルは前回結果のまま or 非表示
3. **ResultsShown（結果表示中）**

   * 検索実行済み
   * 1件以上の結果を描画
   * パネル表示中
4. **NoResult（0件）**

   * 検索実行済み
   * 結果0件
   * パネルには「該当する項目はありません」などのメッセージ

実装的にはフラグ2つくらいで十分：

* `hasQuery`（入力が空かどうか）
* `results.length > 0`

＋ `resultsVisible` を持つ感じです。

---

## 3. キーボード操作仕様

### 3-1. フォーカスの開始

* **Ctrl+F / Cmd+F / F3** などで検索欄にフォーカスを飛ばすかどうかはヘルプアプリ全体のポリシー次第ですが、最低限：

  * マウスクリックで `#hv-search-input` をクリック → フォーカス
  * ページロード時に自動フォーカスするかどうかは *デフォルトは「しない」*（本文を読みたいユーザもいるため）

### 3-2. 入力とデバウンス

* `input` イベントで都度テキストを取得
* 仕様：

  * 最後の入力から **300ms 程度** キー入力が途切れたら検索実行
  * Enter キーが押された場合は **即時検索実行**

### 3-3. Enterキー

* 検索結果パネルがまだ表示されていない／結果0件：

  * Enter で検索実行のみ（パネルを開く）
* 検索結果が表示されていて *選択中の項目がある* 場合：

  * その項目に遷移（`navigateToTopic`）
* 結果はあるが、どれも選択していない（未フォーカス）の場合：

  * **先頭の結果を自動選択して遷移**（シンプルな仕様）

### 3-4. ↑ / ↓（カーソルキー）

* 検索結果が表示されているとき：

  * `ArrowDown`：選択インデックス+1
  * `ArrowUp`：選択インデックス-1
  * インデックスが範囲外に出たらループさせるか、止めるかは好みですが、ここでは**ループさせない**仕様にしておきます（シンプル）。
* 視覚的には：

  * 選択中の `<li>` に `.hv-result--active` を付与（背景色を変える）
* 選択中の項目は `aria-activedescendant` で `listbox` に紐づけておくとアクセシビリティ的にも良いです。

### 3-5. Escキー

* `#hv-search-input` フォーカス中に Esc が押されたとき：

  1. 結果パネルが表示されている場合：

     * **まず結果パネルだけ非表示**にする（入力文字列は残す）
  2. 結果パネルがすでに非表示の場合：

     * 入力文字列をクリア
     * 状態を Idle に戻す
     * フォーカスの扱いは2案：

       * そのまま input に残す
       * `document.body` に移して完全に「検索モード」から抜ける
         → ここでは *検索欄に残す* で良いと思います。

---

## 4. マウス操作仕様

### 4-1. 検索欄クリック

* `input` をクリックすると：

  * フォーカスが入り、Typing状態
  * 既に検索文字列が入っていて結果がある場合は、再び結果パネルを表示してもよい（仕様）

### 4-2. 検索結果クリック

* 各結果 `<li data-topic-id="...">` をクリックすると：

  * 対応する `topic_id` に対して `navigateToTopic(topic_id)` を呼び出す
  * 遷移前に結果パネルを閉じる
* クリック時に「アクティブ表示」CSSクラスを付けても良い（クリックフィードバック）

### 4-3. 外側クリック（クリックアウト）

* 結果パネルが表示されている状態で、

  * 結果以外の領域（本文など）をクリックした場合：
  * 結果パネルを閉じる（検索文字列は保持）

簡単な仕様としては：

* `document.addEventListener('click', ...)` で、

  * `event.target` が `header` 内（input や resultパネル）ではなかったら `resultsVisible=false`

---

## 5. 検索結果表示の内容／スタイル仕様

### 5-1. 1行の項目表示内容

各結果項目には、最低限これを表示：

* **タイトル**（太字）
* **サマリ**（2行程度で省略）
* （任意）topic_id かセクション名のような補助情報（灰色）

例：

```html
<li class="hv-result" data-topic-id="install.windows" role="option">
  <div class="hv-result-title">インストール（Windows）</div>
  <div class="hv-result-summary">Windows へのインストール手順。</div>
</li>
```

### 5-2. 結果数・上限

* 最大表示件数：デフォルト 20 件
* それ以上は表示しない（バックエンドは全件検索しているが、UIのノイズ削減のため）
* 件数をパネルの上部に「n 件ヒット」と表示するかどうかは好みですが、仕様としては：

  * 初期版：表示しなくてもよい
  * 後で「10件中 3件を表示」などに拡張可能

### 5-3. 0件時の表示

NoResult 状態では：

```html
<div class="hv-search-noresult">該当する項目は見つかりませんでした。</div>
```

だけを `#hv-search-results` 内に出す仕様にしておきます。

---

## 6. フローまとめ（ユーザ視点）

### シナリオ1：普通に検索 → 結果クリック

1. ユーザが検索欄に文字を入力
2. 300ms停止 → 検索実行
3. 結果パネルが開き、候補がリスト表示
4. ユーザがマウスで狙った項目をクリック
5. 対応するページ / アンカーにジャンプ
6. 結果パネルは閉じる

### シナリオ2：キーボードだけで操作

1. 検索欄にフォーカス（Tab / ホットキー / マウス）
2. 文字入力 → 300ms停止 or Enter → 検索実行・結果表示
3. ↓ キーで候補を下に移動、↑キーで上に戻る
4. Enter で選択中の候補へジャンプ
5. 検索が不要になったら Esc でパネルを閉じる → もう一度 Esc で入力クリア

---

## 7. アクセシビリティ（軽い仕様）

* `#hv-search-input`：`role="combobox"` / `aria-controls="hv-search-results"` を付けても良い
* `#hv-search-results`：`role="listbox"`
* 各 `<li>`：`role="option"`、`id` を振り、選択中は `aria-selected="true"`

選択中の `<li>` の `id` を `search-results-active-item` などにして、

* `#hv-search-results` に `aria-activedescendant="search-results-active-item"` を付与

という形にすると、スクリーンリーダーのサポートも向上します。

---

## 8. 実装方針メモ（仕様レベル）

仕様上はコード不要ですが、まとめるとやることは：

* **状態管理**

  * `currentQuery`
  * `results[]`
  * `resultsVisible`
  * `activeIndex`
* **イベント**

  * `input` / `keydown`（Enter, Esc, ArrowUp, ArrowDown）
  * `click`（input/結果/外側）
* **描画**

  * 結果リストのDOM更新
  * `.hv-result--active` クラスの付与・削除
  * `hv-search-results` の表示/非表示

という、かなりシンプルな構造です。
このくらいの仕様であれば、素の JS でも数百行以内に収まるイメージになります。
